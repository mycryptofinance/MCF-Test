<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MCF Ecosystem</title>
    <link type="image/x-icon" href="https://i.ibb.co/m58shBg0/image-1.png" rel="shortcut icon">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --bg-dark: #020402;
            --card-bg: #061f14; 
            --primary: #00ff88;
            --primary-dim: rgba(0, 255, 136, 0.15);
            --accent-orange: #ff9f43; 
            --text-main: #f0fdf4;
            --text-muted: #86efac;
            --border: rgba(0, 255, 136, 0.3);
            --neon: 0 0 15px rgba(0, 255, 136, 0.3);
            --error: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            min-height: 100vh;
            display: flex; flex-direction: column;
            background-image: linear-gradient(rgba(0, 255, 136, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 255, 136, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            overflow-x: hidden;
        }

        /* --- HEADER --- */
        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 5%; border-bottom: 1px solid var(--border);
            background: rgba(2, 4, 2, 0.9); backdrop-filter: blur(10px);
            position: sticky; top: 0; z-index: 100;
        }

        .brand { display: flex; align-items: center; gap: 10px; font-weight: 900; font-size: 1.4rem; color: var(--primary); text-shadow: 0 0 10px rgba(0,255,136,0.5); white-space: nowrap; }
        .logo-icon { width: 35px; height: 35px; background: linear-gradient(135deg, #00ff88, #059669); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #000; box-shadow: var(--neon); flex-shrink: 0; }
        
        .wallet-info { 
            display: flex; 
            align-items: center; 
            min-width: 0; 
            justify-content: flex-end;
            gap: 10px;
        }

        /* NETWORK SWITCHER */
        .network-switcher { position: relative; display: inline-block; }
        .network-select { background: rgba(0, 255, 136, 0.05); border: 1px solid var(--primary); color: var(--primary); padding: 8px 12px; border-radius: 8px; font-weight: 700; outline: none; text-align: center; font-size: 0.9rem; cursor: pointer; min-width: 80px; }
        .network-dropdown-content { display: none; position: absolute; top: 100%; right: 0; z-index: 100; min-width: 100%; margin-top: 5px; background-color: #121212; border: 1px solid var(--primary); border-radius: 8px; overflow: hidden; }
        .network-dropdown-content button { text-align: center; width: 100%; padding: 10px 15px; background: none; border: none; color: #fff; cursor: pointer; font-weight: 700; font-size: 0.9rem; transition: background-color 0.2s; }
        .network-dropdown-content button:hover { background-color: rgba(0, 255, 136, 0.1); color: var(--primary); }
        .network-dropdown-content.show { display: block; }

        .btn-connect {
            background: transparent; color: var(--primary); border: 2px solid var(--primary);
            padding: 8px 16px; border-radius: 8px; font-weight: 700; cursor: pointer; transition: 0.3s;
            font-size: 0.9rem; white-space: nowrap;
        }
        .btn-connect:hover { background: var(--primary); color: #000; box-shadow: var(--neon); }
        .btn-connect.connected { border-color: var(--primary); color: #fff; background: rgba(0, 255, 136, 0.1); }
        .btn-connect.connected:hover { background: var(--error); border-color: var(--error); color: #fff; content: "Disconnect"; }

        /* --- MAIN LAYOUT --- */
        main { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 40px; padding: 40px 15px; width: 100%; max-width: 1100px; margin: 0 auto; }

        h2 { color: #fff; margin-bottom: 20px; text-transform: uppercase; font-size: 1.4rem; font-weight: 800; display: flex; align-items: center; gap: 10px; }
        h2 i { color: var(--primary); }

        .card {
            background: var(--card-bg); border: 1px solid var(--border);
            padding: 30px; border-radius: 20px; width: 100%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative; overflow: hidden;
        }
        .card::before {
            content: ''; position: absolute; top:0; left:0; width:100%; height:6px;
            background: linear-gradient(90deg, var(--primary), #004422);
            box-shadow: 0 0 10px var(--primary);
        }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-box { background: rgba(0,0,0,0.4); border: 1px solid #333; border-radius: 12px; padding: 15px; text-align: center; display: flex; flex-direction: column; gap: 5px; }
        .stat-label { font-size: 0.75rem; color: var(--primary); font-weight: 700; letter-spacing: 1px; text-transform: uppercase; }
        .stat-value { font-size: 1.1rem; color: var(--accent-orange); font-family: monospace; font-weight: bold; text-shadow: 0 0 5px rgba(255, 159, 67, 0.3); }

        .input-group label { display: block; margin-bottom: 8px; color: var(--primary); font-size: 0.85rem; text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px; }
        .input-wrapper { display: flex; align-items: center; background: #020b05; border: 1px solid #333; border-radius: 10px; padding-right: 15px; transition: 0.3s; position: relative; }
        .input-wrapper:focus-within { border-color: var(--primary); box-shadow: 0 0 10px rgba(0,255,136,0.1); }
        input { width: 100%; background: transparent; border: none; padding: 18px; color: #fff; font-size: 1.3rem; font-family: monospace; outline: none; }
        .currency { font-weight: 900; color: var(--primary); font-size: 1.2rem; }
        
        .btn-max {
            background: rgba(0, 255, 136, 0.15); color: var(--primary); border: 1px solid var(--primary);
            padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; cursor: pointer;
            margin-right: 10px; transition: 0.2s;
        }
        .btn-max:hover { background: var(--primary); color: #000; }

        .btn-action { width: 100%; padding: 20px; background: var(--primary); border: none; border-radius: 12px; color: #000; font-weight: 900; font-size: 1.2rem; cursor: pointer; text-transform: uppercase; transition: 0.3s; margin-top: 25px; box-shadow: 0 5px 15px rgba(0, 255, 136, 0.3); }
        .btn-action:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0, 255, 136, 0.5); }
        .btn-action:active { transform: scale(0.98); }
        .btn-action:disabled { background: #333; color: #666; cursor: not-allowed; box-shadow: none; transform: none; }

        .staking-plans { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .plan-card { background: rgba(0,0,0,0.4); border: 1px solid #333; border-radius: 10px; padding: 15px 5px; text-align: center; cursor: pointer; transition: 0.3s; display: flex; flex-direction: column; gap: 5px; position: relative; }
        .plan-card:hover { border-color: var(--primary); }
        .plan-card.selected { border-color: var(--primary); background: var(--primary-dim); box-shadow: inset 0 0 10px rgba(0,255,136,0.1); }
        .plan-duration { font-size: 0.8rem; color: var(--text-muted); font-weight: 700; }
        .plan-apy { font-size: 1.2rem; color: #fff; font-weight: 900; }
        
        .staking-calculator { background: rgba(0,255,136,0.05); padding: 15px; border-radius: 10px; margin-top: 15px; display: flex; justify-content: space-between; align-items: center; border: 1px dashed var(--border); }
        .calc-val { font-size: 1.2rem; color: var(--primary); font-weight: bold; font-family: monospace; }

        .user-stakes-container { margin-top: 30px; border-top: 1px solid #333; padding-top: 20px; }
        .stake-row { background: rgba(0,0,0,0.6); border: 1px solid #333; border-radius: 10px; padding: 15px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px; }
        .stake-header { display: flex; justify-content: space-between; color: #fff; font-weight: bold; }
        .stake-timer { font-family: monospace; color: var(--primary); }
        .btn-claim { padding: 10px; width: 100%; background: transparent; border: 1px solid var(--primary); color: var(--primary); border-radius: 6px; font-weight: 700; cursor: pointer; margin-top: 5px; }
        .btn-claim:hover { background: var(--primary); color: #000; }
        .btn-claim:disabled { border-color: #444; color: #555; background: transparent; cursor: not-allowed; }

        .nft-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 25px; width: 100%; perspective: 1000px; }
        .nft-card { background: rgba(10, 20, 15, 0.9); border: 1px solid var(--border); border-radius: 16px; padding: 15px; display: flex; flex-direction: column; align-items: center; transition: transform 0.4s ease, box-shadow 0.4s ease; transform-style: preserve-3d; }
        @media (min-width: 769px) { .nft-card:hover { transform: translateY(-10px) rotateX(5deg) rotateY(2deg); box-shadow: 0 20px 40px rgba(0, 255, 136, 0.2); border-color: var(--primary); z-index: 10; } }
        .nft-image-container { width: 100%; aspect-ratio: 1/1; background: #000; border-radius: 10px; overflow: hidden; margin-bottom: 12px; border: 1px solid #333; }
        .nft-image { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; }
        .nft-card:hover .nft-image { transform: scale(1.1); }
        .btn-mint-nft { width: 100%; padding: 12px; background: transparent; border: 2px solid var(--primary); color: var(--primary); border-radius: 8px; font-weight: 800; cursor: pointer; transition: 0.3s; text-transform: uppercase; font-size: 0.9rem; }
        .btn-mint-nft:hover { background: var(--primary); color: #000; box-shadow: var(--neon); }
        .btn-mint-nft:disabled { border-color: #444; color: #555; background: transparent; box-shadow: none; cursor: not-allowed; }
        .btn-mint-nft.owned { background: #111; border-color: #333; color: #fff; box-shadow: none; cursor: not-allowed; }

        /* --- WALLET MONITOR --- */
        .wallet-monitor { display: flex; align-items: center; background: rgba(6, 31, 20, 0.8); border: 1px solid rgba(0, 255, 136, 0.3); border-radius: 12px; padding: 5px 15px; margin-right: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); backdrop-filter: blur(5px); height: 42px; }
        .balance-group { display: flex; flex-direction: column; justify-content: center; align-items: flex-end; line-height: 1.1; }
        .balance-label { font-size: 0.65rem; color: #86efac; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        .balance-value { font-family: 'Inter', monospace; font-size: 0.95rem; font-weight: 700; color: #fff; white-space: nowrap; }
        .mcf-group .balance-value { color: #00ff88; text-shadow: 0 0 8px rgba(0, 255, 136, 0.4); }
        .balance-divider { width: 1px; height: 24px; background: rgba(255, 255, 255, 0.15); margin: 0 12px; }

        /* --- MOBILE ADAPTATION (FIXED) --- */
        @media (max-width: 768px) {
            /* Делаем шапку вертикальной (2 этажа) */
            header { 
                flex-direction: column; 
                gap: 10px; 
                padding: 10px 15px; 
            }
            .brand {
                width: 100%;
                justify-content: center;
                margin-bottom: 5px;
            }
            
            /* Блок управления на всю ширину и распределен равномерно */
            .wallet-info { 
                width: 100%;
                justify-content: space-between;
                gap: 8px; 
            }
            
            /* Компактный монитор баланса */
            .wallet-monitor { 
                padding: 2px 8px; 
                margin: 0; 
                height: 50px;
                flex-grow: 1; /* Занимает доступное место */
                justify-content: space-around;
            }
            
            .balance-value { font-size: 0.8rem; }
            
            .balance-divider { height: 16px; margin: 0 8px; }
            
            /* Компактные кнопки */
            .network-select, .btn-connect { 
                padding: 6px 8px; 
                font-size: 0.75rem; 
                border-radius: 6px; 
                height: 36px;
                display: flex;
                align-items: center;
                justify-content: center;
                min-width: auto;
            }
            .network-switcher { margin: 0; }

            main { padding: 20px 10px; gap: 20px; }
            .staking-plans { grid-template-columns: 1fr 1fr; gap: 8px; }
            .nft-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .nft-card { padding: 10px; }
            .btn-mint-nft { padding: 8px; font-size: 0.75rem; }
            .footer-socials { flex-direction: column; width: 100%; gap: 10px; }
            .social-btn { width: 100%; justify-content: center; }
        }

        /* --- MODAL --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: #0a1f16; border: 1px solid var(--primary); padding: 30px; border-radius: 16px; width: 90%; max-width: 360px; text-align: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(0,255,136,0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .btn-close { margin-top: 20px; padding: 8px 25px; background: transparent; border: 1px solid #555; color: #aaa; border-radius: 6px; cursor: pointer; }
        .error-msg { color: var(--error); font-size: 0.85rem; margin-top: 10px; display: none; text-align: center; }

        /* --- FOOTER --- */
        footer { border-top: 1px solid #333; padding: 40px 20px; background: rgba(2, 4, 2, 0.95); margin-top: auto; display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .footer-socials { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }
        .social-btn { display: flex; align-items: center; gap: 10px; padding: 12px 25px; background: rgba(0, 255, 136, 0.05); border: 1px solid var(--primary); border-radius: 30px; color: var(--primary); text-decoration: none; font-weight: 700; font-size: 0.9rem; transition: 0.3s; text-transform: uppercase; }
        .social-btn:hover { background: var(--primary); color: #000; box-shadow: 0 0 15px rgba(0, 255, 136, 0.6); transform: translateY(-3px); }
        .footer-copy { color: var(--text-muted); font-size: 0.8rem; }

    </style>
</head>
<body>

    <header>
        <div class="brand">
            <div class="logo-icon">⚡</div>
            MyCryptoFinance DEFI
        </div>
    
        <div class="wallet-info">
            
            <div class="wallet-monitor">
                <div class="balance-group mcf-group">
                    <span class="balance-label">MCF</span>
                    <span id="mcfBalanceDisplay" class="balance-value">0</span>
                </div>
                <div class="balance-divider"></div>
                <div class="balance-group native-group">
                    <span class="balance-label" id="nativeTicker">ETH</span>
                    <span id="nativeBalanceDisplay" class="balance-value">0.000</span>
                </div>
            </div>

            <div class="network-switcher">
                <button id="networkBtn" class="network-select">Sepolia</button>
                <div id="networkDropdown" class="network-dropdown-content">
                    <button onclick="switchNetworkByValue(11155111, 'Sepolia')">Sepolia</button>
                    <button onclick="switchNetworkByValue(1, 'ETH')">ETH</button>
                    <button onclick="switchNetworkByValue(8453, 'Base')">Base</button>
                    <button onclick="switchNetworkByValue(56, 'BNB')">BNB</button>
                </div>
            </div>
    
            <button id="connectBtn" class="btn-connect">CONNECT</button>
            
        </div>
    </header>

    <main>

        <section class="card">
            <h2><i class="fas fa-chart-line"></i> Mint MCF</h2>
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-label">Price per Token</div>
                    <div class="stat-value" id="priceDisplay">...</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Remainder</div>
                    <div class="stat-value" id="soldDisplay">...</div>
                </div>
            </div>
            <div style="position:relative; width: 100%; height: 24px; background: #020b05; border-radius: 12px; overflow: hidden; margin-bottom: 25px; border: 1px solid #333;">
             <div id="supplyBar" style="height: 100%; width: 0%; background: var(--primary); transition: width 0.5s; box-shadow: 0 0 10px var(--primary); opacity: 0.9;"></div>
             <div id="progressText" style="position:absolute; width:100%; text-align:center; top:0; line-height:22px; font-size:0.75rem; color:#fff; font-weight:bold; letter-spacing:1px; text-shadow: 1px 1px 3px #000; z-index: 2;">LOADING...</div>
             </div>
            <div class="input-group">
                <label>You Pay (ETH)</label>
                <div class="input-wrapper">
                    <input type="number" id="mintAmountEth" placeholder="0.01" step="0.001">
                    <button class="btn-max" onclick="setMaxMint()">MAX</button>
                    <span class="currency">ETH</span>
                </div>
            </div>
            <div style="margin-top: 15px; font-size: 0.9rem; color: var(--primary); font-weight: 700; text-transform: uppercase;">
                Estimated Tokens to Receive:
                <div id="calcOutput" style="font-size: 1.4rem; color: var(--primary); margin-top: 5px;">0 MCF</div>
            </div>
            <button id="mintBtn" class="btn-action" onclick="mintToken()" disabled>Connect Wallet</button>
            <div id="mintError" class="error-msg"></div>
        </section>

        <section class="card">
            <h2><i class="fas fa-lock"></i> Staking MCF</h2>
            <div class="staking-plans" id="stakingPlans"></div>
            <div class="input-group">
                <label>Amount MCF to Stake</label>
                <div class="input-wrapper">
                    <input type="number" id="stakeAmount" placeholder="1000">
                    <button class="btn-max" onclick="setMaxStake()">MAX</button>
                    <span class="currency">MCF</span>
                </div>
            </div>
            <div class="staking-calculator">
                <span style="color:var(--text-muted); font-size:0.9rem;">Estimated Reward:</span>
                <span class="calc-val" id="stakeRewardCalc">0.00 MCF</span>
            </div>
            <button id="btnStake" class="btn-action" onclick="stakeTokens()">STAKE TOKENS</button>
            <div class="user-stakes-container" id="userStakesList">
                <p style="text-align:center; color: var(--text-muted); font-size: 0.8rem;">Loading stakes...</p>
            </div>
        </section>

        <section class="card">
            <h2><i class="fas fa-paper-plane"></i> Transfer MCF</h2>
            <div class="input-group">
                <label>To Address</label>
                <div class="input-wrapper"><input type="text" id="recipientAddress" placeholder="0x..."></div>
            </div>
            <div class="input-group" style="margin-top:15px;">
                <label>Amount MCF</label>
                <div class="input-wrapper">
                    <input type="number" id="sendAmount" placeholder="100">
                    <button class="btn-max" onclick="setMaxSend()">MAX</button>
                    <span class="currency">MCF</span>
                </div>
            </div>
            <button class="btn-action" onclick="transferToken()">SEND TOKENS</button>
        </section>

        <section style="width: 100%;">
            <h2 style="text-align: center; margin-top: 10px; justify-content: center;"><i class="fas fa-gem"></i> NFT Editions</h2>
            <div class="nft-grid" id="nftGrid"></div>
        </section>

    </main>

    <footer>
        <div class="footer-socials">
            <button class="social-btn" onclick="addTokenToWallet()">
                <img src="https://upload.wikimedia.org/wikipedia/commons/3/36/MetaMask_Fox.svg" style="width:20px;"> Add to MetaMask
            </button>
            
            <a href="https://x.com/MyCryptoFinance" class="social-btn" target="_blank"><i class="fab fa-twitter"></i> Twitter</a>
            <a href="https://t.me/MyCryproFinance" class="social-btn" target="_blank"><i class="fab fa-telegram-plane"></i> Telegram</a>
            <a href="https://sepolia.etherscan.io/address/0xb66008c221ce3699c7f50aebb07898695845e95f" class="social-btn" target="_blank"><i class="fas fa-search"></i> Etherscan</a>
        </div>
        <div class="footer-copy">
            © 2025 MyCryptoFinance Ecosystem. All rights reserved.
        </div>
    </footer>

    <div id="txModal" class="modal-overlay">
        <div class="modal-content">
            <div id="modalIcon"></div>
            <h3 id="modalTitle" style="color:#fff; margin-bottom:10px;">Processing</h3>
            <div id="modalDesc" style="color:#aaa; font-size:0.9rem; margin-bottom:20px;">Waiting...</div>
            <div id="modalLinkContainer"></div>
            <button class="btn-close" onclick="closeModal()">Close</button>
        </div>
    </div>

    <script>
        const MCF_ADDRESS = "0xb66008C221CE3699c7F50AebB07898695845e95f";
        const NFT_ADDRESS = "0xda2384357a072818a7c1BC4Bbd79Edf22065c95A";
        const STAKING_ADDRESS = "0x825FC04C154053d9F1f697cd9522019224343fC9";

        const MCF_ABI = ["function mint(uint256 amount) payable", "function transfer(address to, uint amount) returns (bool)", "function approve(address spender, uint256 amount) returns (bool)", "function allowance(address owner, address spender) view returns (uint256)", "function balanceOf(address) view returns (uint)", "function mintPrice() view returns (uint)", "function totalSupply() view returns (uint)", "function MAX_SUPPLY() view returns (uint)"];
        const NFT_ABI = ["function mintByMCF(uint256 editionId)", "function hasEditionMinted(address _addr, uint256 editionId) view returns (bool)"];
        const STAKING_ABI = ["function stake(uint256 amount, uint8 tier)", "function unstake(uint8 tier)", "function calculateReward(address user, uint8 tier) view returns (uint256)", "function userStakes(address, uint8) view returns (uint256 amount, uint256 startTime, uint256 lockDuration)", "function tierConfigs(uint8) view returns (uint256 lockDuration, uint256 rewardMultiplier)"];

        const STAKING_PLANS = [
            { id: 0, days: 0, apy: 5, label: "FLEXIBLE" },
            { id: 1, days: 7, apy: 10, label: "7 DAYS" },
            { id: 2, days: 30, apy: 15, label: "30 DAYS" },
            { id: 3, days: 90, apy: 25, label: "90 DAYS" }
        ];

        const nftImages = [
            "https://olive-random-anteater-963.mypinata.cloud/ipfs/bafkreicwkh3wdpe4bec5aimnjirtp73sjfadkuwe3sikyatatguxbvfbp4", "https://olive-random-anteater-963.mypinata.cloud/ipfs/bafkreiacnj5vbnw32n2legauzdmlrn5377ifl5ozixp2em6uka5syfa5qe", "https://olive-random-anteater-963.mypinata.cloud/ipfs/bafkreiepkz7zfeyrb6u4u7pg7obechyrqei7l6iy7wc2fdfjm3ims6l2se", "https://olive-random-anteater-963.mypinata.cloud/ipfs/bafkreifnzbz6pr7wy7klmb5tknqi6mnfuh2bxdiy73t2llowdykdxu3boa", "https://olive-random-anteater-963.mypinata.cloud/ipfs/bafkreiaz2w5z7cjbz2ggcgfwovdhpimbipuueffemkw73wq3i7lk5uzifm", "https://olive-random-anteater-963.mypinata.cloud/ipfs/bafkreigkk4y57l7s4fsts5wsjjaqtoi362nmwqhassptuu4k46o3rpdvum", "https://olive-random-anteater-963.mypinata.cloud/ipfs/bafkreigdctqvwaosav37brqwxnglfrnie7puthgfsvvxmroybnqov4aayu", "https://olive-random-anteater-963.mypinata.cloud/ipfs/bafkreiaxboy632fm55nwaeg322d2qsdadzcg6gzhfcntktpdpab6nbmzdi"
        ];
        const nftNames = ["EAGLE", "WOLF", "FOX", "BEAR", "HORSE", "BULL", "LION", "OWL"];

        let provider, signer, mcfContract, nftContract, stakingContract;
        let userAccount = null, isConnected = false;
        let contractState = { mintPriceWei: ethers.BigNumber.from(0), tokensPerEth: 0 };
        let selectedPlanId = 1;
        let loadedStakes = [];

        // --- INIT ---
        const nftGrid = document.getElementById('nftGrid');
        const plansContainer = document.getElementById('stakingPlans');

        nftGrid.innerHTML = nftImages.map((img, i) => `
            <div class="nft-card">
                <div class="nft-image-container"><img src="${img}" class="nft-image" loading="lazy"></div>
                <div style="font-size:0.9rem; color:#fff; font-weight:bold; margin-top:5px;">${nftNames[i] || "Edition #" + (i + 1)}</div>
                <div style="font-size:0.8rem; color:var(--primary); margin-bottom:5px;">10,000 MCF</div>
                <button class="btn-mint-nft" id="btn-nft-${i+1}" onclick="mintNFT(${i+1})" disabled>Connect</button>
            </div>`).join('');

        function renderPlans() {
            plansContainer.innerHTML = STAKING_PLANS.map(plan => `
                <div class="plan-card ${plan.id === selectedPlanId ? 'selected' : ''}" onclick="selectPlan(${plan.id})">
                    <div class="plan-duration">${plan.label}</div>
                    <div class="plan-apy">${plan.apy}<span>%</span></div>
                </div>`).join('');
            calcStakeReward();
        }
        renderPlans();

        function selectPlan(id) { selectedPlanId = id; renderPlans(); }
        document.getElementById('stakeAmount').addEventListener('input', calcStakeReward);
        
        function calcStakeReward() {
            const amt = parseFloat(document.getElementById('stakeAmount').value) || 0;
            const plan = STAKING_PLANS.find(p => p.id === selectedPlanId);
            let reward = plan.days === 0 ? amt * (plan.apy / 100) / 365 : amt * (plan.apy / 100) * (plan.days / 365);
            document.getElementById('stakeRewardCalc').innerText = plan.days === 0 ? `~${reward.toFixed(2)} / DAY` : `+${reward.toFixed(2)} MCF`;
        }

        // --- LOGIC ---
        async function connect() {
            if (!window.ethereum) return alert("Install MetaMask");
            try {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                userAccount = await signer.getAddress();
                mcfContract = new ethers.Contract(MCF_ADDRESS, MCF_ABI, signer);
                nftContract = new ethers.Contract(NFT_ADDRESS, NFT_ABI, signer);
                stakingContract = new ethers.Contract(STAKING_ADDRESS, STAKING_ABI, signer);

                isConnected = true;
                await updateBalances();
                updateUI();
                fetchMCFData();
                checkNFTs();
                loadRealStakes();
                
                window.ethereum.on('accountsChanged', () => window.location.reload());
                window.ethereum.on('chainChanged', () => window.location.reload());
            } catch (e) { console.error(e); openModal('error', "Connection Error"); }
        }

        function updateUI() {
            // Feature 3: Truncated Address
            const shortAddr = userAccount.substring(0, 6) + "..." + userAccount.substring(userAccount.length - 4);
            document.getElementById('connectBtn').innerText = shortAddr;
            document.getElementById('connectBtn').classList.add("connected");
            
            document.getElementById('mintBtn').innerText = "BUY TOKENS";
            document.getElementById('mintBtn').disabled = false;
            document.querySelectorAll('.btn-mint-nft').forEach(b => { b.innerText="MINT"; b.disabled=false; });
            
            provider.getNetwork().then(net => {
                const btn = document.getElementById('networkBtn');
                if(btn) {
                    if(net.chainId === 11155111) btn.innerText = "Sepolia";
                    else if(net.chainId === 1) btn.innerText = "ETH";
                    else if(net.chainId === 8453) btn.innerText = "Base";
                    else if(net.chainId === 56) btn.innerText = "BNB";
                    else btn.innerText = "Wrong Net";
                }
            });
        }
        
        document.getElementById('connectBtn').addEventListener('click', () => { if(!isConnected) connect(); else window.location.reload(); });

        async function mintToken() {
            if (!isConnected) return;
            const val = document.getElementById('mintAmountEth').value;
            if(!val) return;
            openModal('loading', "Confirm Transaction...");
            try {
                const ethVal = ethers.utils.parseEther(val);
                const tokens = ethVal.div(contractState.mintPriceWei);
                const tx = await mcfContract.mint(tokens, { value: ethVal });
                openModal('loading', "Minting...");
                const receipt = await tx.wait();
                
                const tokensToMintInUnits = ethVal.div(contractState.mintPriceWei);
                const tokensToMint = tokensToMintInUnits.mul(ethers.BigNumber.from(10).pow(18));
                const tokenAmount = tokensToMintInUnits.toLocaleString('en-US');
            
                openModal('success', `Successful Mint!`, receipt.transactionHash, `Received ${tokenAmount} MCF`);

                fetchMCFData();
                updateBalances();
                await updateBalances();
            } catch(e) { openModal('error', e.reason || e.message); }
        }

        async function transferToken() {
            if (!isConnected) return;
            const to = document.getElementById('recipientAddress').value;
            const amt = document.getElementById('sendAmount').value;
            if(!ethers.utils.isAddress(to) || !amt) return alert("Invalid Input");
            openModal('loading', "Transferring...");
            try {
                const val = ethers.utils.parseEther(amt);
                const tx = await mcfContract.transfer(to, val);
                const receipt = await tx.wait();
                openModal('success', `Successful Sending!`, receipt.transactionHash, `Sent ${amt} MCF`);
                await updateBalances();
            } catch(e) { openModal('error', e.reason || e.message); }
        }

        async function mintNFT(id) {
            if (!isConnected) return;
            openModal('loading', "Checking...");
            try {
                const price = ethers.utils.parseEther("10000");
                const allow = await mcfContract.allowance(userAccount, NFT_ADDRESS);
                if(allow.lt(price)) {
                    openModal('loading', "Approve MCF...");
                    const txApp = await mcfContract.approve(NFT_ADDRESS, price);
                    await txApp.wait();
                }
                openModal('loading', "Minting NFT...");
                const tx = await nftContract.mintByMCF(id);
                const receipt = await tx.wait();
                const nftName = nftNames[id - 1] || `Edition #${id}`;
                openModal('success', `NFT successfully mined`, receipt.transactionHash, `NFT received: ${nftName}`);
                checkNFTs();
                await updateBalances();
            } catch(e) { openModal('error', e.reason || e.message); }
        }

        async function stakeTokens() {
            if (!isConnected) return alert("Connect Wallet!");
            const amt = document.getElementById('stakeAmount').value;
            if(!amt || amt <= 0) return alert("Enter Amount");
            const planId = selectedPlanId; 
            const plan = STAKING_PLANS.find(p => p.id === planId);
            openModal('loading', "Checking Allowance...");
            try {
                const weiAmt = ethers.utils.parseEther(amt);
                const allowance = await mcfContract.allowance(userAccount, STAKING_ADDRESS);
                if(allowance.lt(weiAmt)) {
                    openModal('loading', "Approve Staking...");
                    const txApp = await mcfContract.approve(STAKING_ADDRESS, weiAmt);
                    await txApp.wait();
                }
                openModal('loading', "Staking...");
                const txStake = await stakingContract.stake(weiAmt, planId);
                const receipt = await txStake.wait();
                openModal('success', `Successful Staking!`, receipt.transactionHash, `Staked ${amt} MCF on ${plan.label}`);
                loadRealStakes(); 
                await updateBalances();
            } catch (e) { console.error(e); openModal('error', e.reason || e.message); }
        }

        async function loadRealStakes() {
            const container = document.getElementById('userStakesList');
            container.innerHTML = '<p style="text-align:center; color: #888;">Fetching blockchain data...</p>';
            loadedStakes = [];
            try {
                for (let i = 0; i < 4; i++) {
                    const stakeData = await stakingContract.userStakes(userAccount, i);
                    if (stakeData.amount.gt(0)) {
                        const reward = await stakingContract.calculateReward(userAccount, i);
                        loadedStakes.push({
                            tierId: i,
                            amount: ethers.utils.formatEther(stakeData.amount),
                            startTime: stakeData.startTime.toNumber(),
                            lockDuration: stakeData.lockDuration.toNumber(),
                            reward: ethers.utils.formatEther(reward),
                            label: STAKING_PLANS[i].label,
                            isFlexible: i === 0
                        });
                    }
                }
                renderStakesUI();
            } catch (e) { container.innerHTML = '<p style="text-align:center; color: var(--error);">Error loading stakes</p>'; }
        }

        function renderStakesUI() {
            const container = document.getElementById('userStakesList');
            if (loadedStakes.length === 0) {
                container.innerHTML = '<p style="text-align:center; color: #666; font-size: 0.8rem;">No active stakes found.</p>';
                return;
            }
            container.innerHTML = loadedStakes.map((stake) => `
                <div class="stake-row">
                    <div class="stake-header"><span>${stake.label}</span><span>${parseFloat(stake.amount).toFixed(0)} MCF</span></div>
                    <div style="display:flex; justify-content:space-between; color:#aaa; font-size:0.8rem;">
                        <span>Reward: <b style="color:#fff;">+${parseFloat(stake.reward).toFixed(2)}</b></span>
                        <span class="stake-timer" id="timer-tier-${stake.tierId}">Loading...</span>
                    </div>
                    <button class="btn-claim" id="btn-claim-${stake.tierId}" onclick="claimStake(${stake.tierId})" disabled>LOCKED</button>
                </div>`).join('');
        }

        setInterval(() => {
            if(!loadedStakes.length) return;
            const now = Math.floor(Date.now() / 1000);
            loadedStakes.forEach(stake => {
                const el = document.getElementById(`timer-tier-${stake.tierId}`);
                const btn = document.getElementById(`btn-claim-${stake.tierId}`);
                if(!el) return;
                if(stake.isFlexible) {
                    el.innerText = "Accruing...";
                    btn.disabled = false;
                    btn.innerText = "UNSTAKE & CLAIM";
                } else {
                    const endTime = stake.startTime + stake.lockDuration;
                    const left = endTime - now;
                    if(left <= 0) {
                        el.innerText = "Unlocked"; el.style.color = "#00ff88";
                        btn.disabled = false;
                        btn.innerText = "CLAIM & UNSTAKE";
                    } else {
                        const d = Math.floor(left / 86400);
                        const h = Math.floor((left % 86400) / 3600);
                        const m = Math.floor((left % 3600) / 60);
                        const s = left % 60;
                        el.innerText = `${d}d ${h}h ${m}m ${s}s`;
                    }
                }
            });
        }, 1000);

        async function claimStake(tierId) {
            openModal('loading', "Unstaking...");
            try {
                const tx = await stakingContract.unstake(tierId);
                const receipt = await tx.wait();
                openModal('success', `Successful Steak Removal!`, receipt.transactionHash, `Your tokens and rewards have been returned.`);
                loadRealStakes();
                await updateBalances();
            } catch (e) { openModal('error', e.reason || e.message); }
        }

        function getExplorerUrl(chainId, txHash) {
            let baseUrl = "https://etherscan.io";
            switch(chainId) {
                case 11155111: baseUrl = "https://sepolia.etherscan.io"; break;
                case 8453: baseUrl = "https://basescan.org"; break;
                case 56: baseUrl = "https://bscscan.com"; break;
            }
            return `${baseUrl}/tx/${txHash}`;
        }

        async function updateBalances() {
            if (!provider || !userAccount) return;
            try {
                const nativeBalanceWei = await provider.getBalance(userAccount);
                const formattedNative = parseFloat(ethers.utils.formatEther(nativeBalanceWei)).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 4 });
                
                let mcfFormatted = "0";
                if (mcfContract) {
                    const mcfBalanceWei = await mcfContract.balanceOf(userAccount);
                    const mcfNum = parseFloat(ethers.utils.formatEther(mcfBalanceWei));
                    if (mcfNum > 0) mcfFormatted = mcfNum.toLocaleString('en-US', { maximumFractionDigits: 2 });
                }

                const net = await provider.getNetwork();
                let ticker = "ETH";
                if (net.chainId === 11155111) ticker = "Sepolia ETH";
                if (net.chainId === 56) ticker = "BNB";
                
                document.getElementById('nativeBalanceDisplay').innerText = formattedNative;
                document.getElementById('nativeTicker').innerText = ticker;
                document.getElementById('mcfBalanceDisplay').innerText = mcfFormatted;
            } catch (e) {
                console.error("Update Balances Error:", e);
            }
        }

        async function fetchMCFData() {
            if(!mcfContract) return;
            try {
                const price = await mcfContract.mintPrice();
                contractState.mintPriceWei = price;
                const total = await mcfContract.totalSupply();
                const max = await mcfContract.MAX_SUPPLY();
                const remaining = max.sub(total);
                
                document.getElementById('soldDisplay').innerText = parseFloat(ethers.utils.formatEther(remaining)).toLocaleString('ru-RU', { maximumFractionDigits: 0 });
                document.getElementById('priceDisplay').innerText = ethers.utils.formatEther(price) + " ETH";
                
                const pct = total.mul(100).div(max).toNumber();
                document.getElementById('supplyBar').style.width = pct + "%";
                document.getElementById('progressText').innerText = `${parseFloat(ethers.utils.formatEther(total)).toLocaleString('ru-RU')} / ${parseFloat(ethers.utils.formatEther(max)).toLocaleString('ru-RU')} SOLD`;
            } catch(e){}
        }

        async function checkNFTs() {
            if(!nftContract) return;
            for(let i=1; i<=8; i++) {
                try {
                    const done = await nftContract.hasEditionMinted(userAccount, i);
                    const btn = document.getElementById(`btn-nft-${i}`);
                    if(done) { btn.innerText="ALREADY MINTED"; btn.disabled=true; btn.classList.add('owned'); }
                } catch(e){}
            }
        }

        async function switchNetwork(id) {
            try { await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: ethers.utils.hexValue(parseInt(id)) }] }); }
            catch(e) { openModal('error', "Switch failed"); }
        }

        
          const mintEthInput = document.getElementById('mintAmountEth');
          mintEthInput.addEventListener('input', (e) => {
         
        if (contractState.mintPriceWei && contractState.mintPriceWei.gt(0)) {
        const inputValue = e.target.value;
        
        
        if (!inputValue) {
            document.getElementById('calcOutput').innerText = "0 MCF";
            return;
        }

        try {
            
            const ethAmount = parseFloat(inputValue);
            const ethPrice = parseFloat(ethers.utils.formatEther(contractState.mintPriceWei));
            
            if (ethPrice > 0) {
                
                const tokens = ethAmount / ethPrice;
                
                
                const formattedTokens = tokens.toLocaleString('ru-RU', { maximumFractionDigits: 4 });
                
                document.getElementById('calcOutput').innerText = formattedTokens + " MCF";
            } else {
                document.getElementById('calcOutput').innerText = "0 MCF";
            }
            } catch (error) {
            console.error("Calculator Error:", error);
            document.getElementById('calcOutput').innerText = "0 MCF";
            }
           } else {
             
             document.getElementById('calcOutput').innerText = "Loading price...";
             }
        });

        // Feature 1: MAX Functions
        async function setMaxMint() {
            if(!provider || !userAccount) return;
            const bal = await provider.getBalance(userAccount);
            // Leave slight buffer for gas (0.005 ETH)
            const gasBuffer = ethers.utils.parseEther("0.005");
            let maxVal = bal.sub(gasBuffer);
            if(maxVal.lt(0)) maxVal = ethers.BigNumber.from(0);
            document.getElementById('mintAmountEth').value = ethers.utils.formatEther(maxVal);
            document.getElementById('mintAmountEth').dispatchEvent(new Event('input'));
        }

        async function setMaxStake() {
            if(!mcfContract || !userAccount) return;
            const bal = await mcfContract.balanceOf(userAccount);
            document.getElementById('stakeAmount').value = ethers.utils.formatEther(bal);
            document.getElementById('stakeAmount').dispatchEvent(new Event('input'));
        }

        async function setMaxSend() {
            if(!mcfContract || !userAccount) return;
            const bal = await mcfContract.balanceOf(userAccount);
            document.getElementById('sendAmount').value = ethers.utils.formatEther(bal);
        }

        // Feature 2: Add Token Function
        async function addTokenToWallet() {
            try {
                await window.ethereum.request({
                    method: 'wallet_watchAsset',
                    params: {
                        type: 'ERC20',
                        options: { address: MCF_ADDRESS, symbol: 'MCF', decimals: 18 },
                    },
                });
            } catch (error) { console.error(error); }
        }

        function openModal(type, title, txHash = null, details = null) {
            const m = document.getElementById('txModal'); m.style.display='flex';
            let iconHtml = '', detailsHtml = '';

            switch (type) {
                case 'loading':
                    iconHtml = '<div class="spinner"></div>';
                    document.getElementById('modalDesc').innerText = title;
                    break;
                case 'success':
                    iconHtml = '✅';
                    document.getElementById('modalDesc').innerText = title; 
                    if (details) detailsHtml += `<p style="font-size: 0.9rem; color: #ccc; margin-top: 5px;">${details}</p>`;
                    if (txHash && provider) {
                        provider.getNetwork().then(net => {
                            const explorerUrl = getExplorerUrl(net.chainId, txHash);
                            const shortHash = txHash.substring(0, 6) + '...' + txHash.substring(txHash.length - 4);
                            document.getElementById('modalIcon').innerHTML = iconHtml;
                            document.getElementById('modalDesc').innerHTML = `
                                <h3 style="margin: 0; color: var(--primary);">${title}</h3>
                                ${detailsHtml}
                                <div style="margin-top: 10px; font-size: 0.8rem;">
                                    <span style="color: #888;">TX Hash: </span>
                                    <a href="${explorerUrl}" target="_blank" style="color: var(--primary); text-decoration: none; font-weight: bold;">${shortHash} ↗</a>
                                </div>`;
                        });
                        return; 
                    }
                    break;
                case 'error':
                    iconHtml = '❌';
                    document.getElementById('modalDesc').innerText = `Error: ${title}`;
                    break;
            }
            document.getElementById('modalIcon').innerHTML = iconHtml;
            document.getElementById('modalDesc').innerHTML = `<h3 style="margin: 0; color: ${type==='success'?'var(--primary)':'var(--error)'};">${title}</h3>`;
            if (type === 'error') document.getElementById('modalDesc').innerText = title;
        }
        
        function closeModal() { document.getElementById('txModal').style.display='none'; }

        document.getElementById('networkBtn').addEventListener('click', function() { document.getElementById('networkDropdown').classList.toggle('show'); });
        window.onclick = function(event) {
            if (!event.target.matches('.network-select')) {
                const dropdown = document.getElementById('networkDropdown');
                if (dropdown && dropdown.classList.contains('show')) dropdown.classList.remove('show');
            }
        }
        function switchNetworkByValue(chainId, chainName) {
            document.getElementById('networkBtn').innerText = chainName;
            switchNetwork(chainId); 
            document.getElementById('networkDropdown').classList.remove('show');
        }
    </script>
</body>
</html>
